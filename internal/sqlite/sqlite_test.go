package sqlite

import (
	"database/sql"
	"encoding/hex"
	"github.com/Layr-Labs/go-sidecar/internal/logger"
	"github.com/Layr-Labs/go-sidecar/internal/tests"
	"github.com/Layr-Labs/go-sidecar/internal/types/numbers"
	"github.com/shopspring/decimal"
	"github.com/stretchr/testify/assert"
	"math/big"
	"strings"
	"testing"
)

func Test_Sqlite(t *testing.T) {
	l, _ := logger.NewLogger(&logger.LoggerConfig{Debug: true})

	t.Run("Should use the bytesToHex function", func(t *testing.T) {
		query := `
			with json_values as (
				select 
					cast('{"newWithdrawalRoot": [218, 200, 138, 86, 38, 9, 156, 119, 73, 13, 168, 40, 209, 43, 238, 83, 234, 177, 230, 73, 120, 205, 255, 143, 255, 216, 51, 209, 137, 100, 163, 233] }' as text) as json_col
				from (select 1)
			)
			select
				bytes_to_hex(json_extract(json_col, '$.newWithdrawalRoot')) AS withdrawal_hex
			from json_values
			limit 1
		`
		s := NewSqlite(&SqliteConfig{
			Path:           SqliteInMemoryPath,
			ExtensionsPath: []string{tests.GetSqliteExtensionsPath()},
		}, l)
		grm, err := NewGormSqliteFromSqlite(s)
		assert.Nil(t, err)

		type results struct {
			WithdrawalHex string
		}

		hexValue := &results{}
		res := grm.Raw(query).Scan(&hexValue)

		expectedBytes := []byte{218, 200, 138, 86, 38, 9, 156, 119, 73, 13, 168, 40, 209, 43, 238, 83, 234, 177, 230, 73, 120, 205, 255, 143, 255, 216, 51, 209, 137, 100, 163, 233}

		assert.Nil(t, res.Error)
		assert.Equal(t, strings.ToLower(hex.EncodeToString(expectedBytes)), hexValue.WithdrawalHex)
	})
	t.Run("Should sum two really big numbers that are stored as strings", func(t *testing.T) {
		shares1 := "1670000000000000000000"
		shares2 := "1670000000000000000000"

		type shares struct {
			Shares string
		}

		operatorShares := []*shares{
			&shares{
				Shares: shares1,
			},
			&shares{
				Shares: shares2,
			},
		}

		s := NewSqlite(&SqliteConfig{
			Path:           SqliteInMemoryPath,
			ExtensionsPath: []string{tests.GetSqliteExtensionsPath()},
		}, l)
		grm, err := NewGormSqliteFromSqlite(s)
		assert.Nil(t, err)

		createQuery := `
			create table shares (
				shares TEXT NOT NULL
			)
		`
		res := grm.Exec(createQuery)
		assert.Nil(t, res.Error)

		res = grm.Model(&shares{}).Create(&operatorShares)
		assert.Nil(t, res.Error)

		query := `
			select
				sum_big(shares) as total
			from shares
		`
		var total string
		res = grm.Raw(query).Scan(&total)
		assert.Nil(t, res.Error)

		shares1Big, _ := new(big.Int).SetString(shares1, 10)
		shares2Big, _ := new(big.Int).SetString(shares2, 10)

		expectedTotal := shares1Big.Add(shares1Big, shares2Big)

		assert.Equal(t, expectedTotal.String(), total)
	})
	t.Run("Custom Go functions", func(t *testing.T) {
		t.Run("Should call calc_raw_tokens_per_day", func(t *testing.T) {
			query := `select calc_raw_tokens_per_day('100', 100) as amt`

			s := NewSqlite(&SqliteConfig{
				Path:           SqliteInMemoryPath,
				ExtensionsPath: []string{tests.GetSqliteExtensionsPath()},
			}, l)
			grm, err := NewGormSqliteFromSqlite(s)
			assert.Nil(t, err)

			var result string
			res := grm.Raw(query).Scan(&result)
			assert.Nil(t, res.Error)

			assert.Equal(t, "86400.0000000000080179", result)

		})
	})
	t.Run("Custom C functions", func(t *testing.T) {
		t.Run("Should call pre_nile_tokens_per_day", func(t *testing.T) {
			expectedRoundedValue := "1428571428571427000000000000000000000"

			amount := "1428571428571428571428571428571428571.4142857142857143"

			query := `select pre_nile_tokens_per_day(@amount) as amt`

			s := NewSqlite(&SqliteConfig{
				Path:           SqliteInMemoryPath,
				ExtensionsPath: []string{tests.GetSqliteExtensionsPath()},
			}, l)
			grm, err := NewGormSqliteFromSqlite(s)
			assert.Nil(t, err)

			var result string
			res := grm.Raw(query, sql.Named("amount", amount)).Scan(&result)
			assert.Nil(t, res.Error)

			assert.Equal(t, expectedRoundedValue, result)

		})
		t.Run("Should call amazon_staker_token_rewards", func(t *testing.T) {
			values := [][]string{
				[]string{"0.092173497467823", "142857142857142700000000", "13167642495403300000000"},
				[]string{"0.340626972698262", "142857142857142700000000", "48660996099751700000000"},
				[]string{"0.149069696024661", "142857142857142700000000", "21295670860665800000000"},
				[]string{"0.418129833809252", "142857142857142700000000", "59732833401321600000000"},
				[]string{"0.092173497467823", "142857142857142700000000", "13167642495403300000000"},
				[]string{"0.340626972698262", "142857142857142700000000", "48660996099751700000000"},
				[]string{"0.149069696024661", "142857142857142700000000", "21295670860665800000000"},
				[]string{"0.418129833809252", "142857142857142700000000", "59732833401321600000000"},
				[]string{"0.092173497467823", "142857142857142700000000", "13167642495403300000000"},
				[]string{"0.340626972698262", "142857142857142700000000", "48660996099751700000000"},
				[]string{"0.149069696024661", "142857142857142700000000", "21295670860665800000000"},
				[]string{"0.418129833809252", "142857142857142700000000", "59732833401321600000000"},
				[]string{"0.092173497467823", "142857142857142700000000", "13167642495403300000000"},
				[]string{"0.340626972698262", "142857142857142700000000", "48660996099751700000000"},
				[]string{"0.149069696024661", "142857142857142700000000", "21295670860665800000000"},
				[]string{"0.418129833809252", "142857142857142700000000", "59732833401321600000000"},
				[]string{"0.092173497467823", "142857142857142700000000", "13167642495403300000000"},
				[]string{"0.340626972698262", "142857142857142700000000", "48660996099751700000000"},
				[]string{"0.149069696024661", "142857142857142700000000", "21295670860665800000000"},
				[]string{"0.418129833809252", "142857142857142700000000", "59732833401321600000000"},
				[]string{"0.092173497467823", "142857142857142700000000", "13167642495403300000000"},
				[]string{"0.340626972698262", "142857142857142700000000", "48660996099751700000000"},
				[]string{"0.149069696024661", "142857142857142700000000", "21295670860665800000000"},
				[]string{"0.418129833809252", "142857142857142700000000", "59732833401321600000000"},
				[]string{"0.092173497467823", "142857142857142700000000", "13167642495403300000000"},
				[]string{"0.340626972698262", "142857142857142700000000", "48660996099751700000000"},
				[]string{"0.149069696024661", "142857142857142700000000", "21295670860665800000000"},
				[]string{"0.418129833809252", "142857142857142700000000", "59732833401321600000000"},
			}

			s := NewSqlite(&SqliteConfig{
				Path:           SqliteInMemoryPath,
				ExtensionsPath: []string{tests.GetSqliteExtensionsPath()},
			}, l)
			grm, err := NewGormSqliteFromSqlite(s)
			assert.Nil(t, err)

			for _, v := range values {
				stakerProportion := v[0]
				tokensPerDay := v[1]
				expectedResult := v[2]

				query := `select amazon_staker_token_rewards(@stakerProportion, @tokensPerDay) as amt`

				var result string
				res := grm.Raw(query, sql.Named("stakerProportion", stakerProportion), sql.Named("tokensPerDay", tokensPerDay)).Scan(&result)
				assert.Nil(t, res.Error)

				// expected, _ := decimal.NewFromString(expectedResult)
				// actual, _ := decimal.NewFromString(result)

				assert.Equal(t, expectedResult, result)
			}
		})
		t.Run("Should call nile_staker_token_rewards", func(t *testing.T) {
			values := [][]string{
				[]string{"0.000000240375027", "71428571428571350000000", "17169644785714300"},
				[]string{"0.000000182660779", "71428571428571350000000", "13047198500000000"},
				[]string{"0.000000182637329", "71428571428571350000000", "13045523500000000"},
				[]string{"0.000003470116004", "71428571428571350000000", "247865428857143000"},
				[]string{"0.000021918909001", "71428571428571350000000", "1565636357214280000"},
				[]string{"0.000003653540054", "71428571428571350000000", "260967146714285000"},
				[]string{"0.000000913478881", "71428571428571350000000", "65248491499999900"},
				[]string{"0.000000013027298", "71428571428571350000000", "930521285714285"},
				[]string{"0.000002554296328", "71428571428571350000000", "182449737714286000"},
				[]string{"0.000001826748407", "71428571428571350000000", "130482029071428000"},
				[]string{"0.000001826999023", "71428571428571350000000", "130499930214286000"},
				[]string{"0.00000018267561", "71428571428571350000000", "13048257857142800"},
				[]string{"0.000000182685769", "71428571428571350000000", "13048983500000000"},
				[]string{"0.000002366274776", "71428571428571350000000", "169019626857143000"},
				[]string{"0.00000164380537", "71428571428571350000000", "117414669285714000"},
				[]string{"0.000000370168897", "71428571428571350000000", "26440635500000000"},
				[]string{"0.000000182691271", "71428571428571350000000", "13049376500000000"},
				[]string{"0.000000365323009", "71428571428571350000000", "26094500642857100"},
				[]string{"0.000000182677002", "71428571428571350000000", "13048357285714300"},
				[]string{"0.000000182702737", "71428571428571350000000", "13050195500000000"},
				[]string{"0.000000182677002", "71428571428571350000000", "13048357285714300"},
				[]string{"0.000000018269785", "71428571428571350000000", "1304984642857140"},
				[]string{"0.000000182681938", "71428571428571350000000", "13048709857142800"},
				[]string{"0.000001987375845", "71428571428571350000000", "141955417500000000"},
				[]string{"0.000000042012909", "71428571428571350000000", "3000922071428570"},
				[]string{"0.000000730597415", "71428571428571350000000", "52185529642857100"},
				[]string{"0.000000182677002", "71428571428571350000000", "13048357285714300"},
				[]string{"0.000000039457125", "71428571428571350000000", "2818366071428570"},
				[]string{"0.000000365369184", "71428571428571350000000", "26097798857142800"},
				[]string{"0.000000182677726", "71428571428571350000000", "13048409000000000"},
				[]string{"0.000000310572503", "71428571428571350000000", "22183750214285700"},
				[]string{"0.000004226908614", "71428571428571350000000", "301922043857143000"},
				[]string{"0.000000365417168", "71428571428571350000000", "26101226285714300"},
				[]string{"0.000000177185592", "71428571428571350000000", "12656113714285700"},
				[]string{"0.000001643917568", "71428571428571350000000", "117422683428571000"},
				[]string{"0.00000018267416", "71428571428571350000000", "13048154285714300"},
				[]string{"0.000002740461681", "71428571428571350000000", "195747262928571000"},
				[]string{"0.000000002557447", "71428571428571350000000", "182674785714286"},
				[]string{"0.000001826557", "71428571428571350000000", "130468357142857000"},
				[]string{"0.000000164389211", "71428571428571350000000", "11742086500000000"},
				[]string{"0.000002739983387", "71428571428571350000000", "195713099071428000"},
				[]string{"0.000000036533111", "71428571428571350000000", "2609507928571430"},
				[]string{"0.000000182671879", "71428571428571350000000", "13047991357142800"},
				[]string{"0.000000091309387", "71428571428571350000000", "6522099071428560"},
				[]string{"0.000000182670306", "71428571428571350000000", "13047879000000000"},
				[]string{"0.000007305801647", "71428571428571350000000", "521842974785714000"},
				[]string{"0.000000182690094", "71428571428571350000000", "13049292428571400"},
				[]string{"0.000004749759756", "71428571428571350000000", "339268554000000000"},
				[]string{"0.000000190360649", "71428571428571350000000", "13597189214285700"},
				[]string{"0.000000182672242", "71428571428571350000000", "13048017285714300"},
				[]string{"0.000000365328113", "71428571428571350000000", "26094865214285700"},
				[]string{"0.000002739922568", "71428571428571350000000", "195708754857143000"},
				[]string{"0.000000182660056", "71428571428571350000000", "13047146857142800"},
				[]string{"0.00000006211612", "71428571428571350000000", "4436865714285710"},
				[]string{"0.000000049568549", "71428571428571350000000", "3540610642857140"},
				[]string{"0.000000913489267", "71428571428571350000000", "65249233357142800"},
				[]string{"0.000000182580477", "71428571428571350000000", "13041462642857100"},
				[]string{"0.000001643953541", "71428571428571350000000", "117425252928571000"},
				[]string{"0.000000182670651", "71428571428571350000000", "13047903642857100"},
				[]string{"0.000000018269744", "71428571428571350000000", "1304981714285710"},
				[]string{"0.000000367521622", "71428571428571350000000", "26251544428571400"},
				[]string{"0.000000007306545", "71428571428571350000000", "521896071428571"},
				[]string{"0.000000182670306", "71428571428571350000000", "13047879000000000"},
				[]string{"0.000000018269828", "71428571428571350000000", "1304987714285710"},
				[]string{"0.000000164413436", "71428571428571350000000", "11743816857142800"},
				[]string{"0.000000027764809", "71428571428571350000000", "1983200642857140"},
				[]string{"0.000000401954789", "71428571428571350000000", "28711056357142800"},
				[]string{"0.000000124233734", "71428571428571350000000", "8873838142857130"},
				[]string{"0.000000482267287", "71428571428571350000000", "34447663357142800"},
				[]string{"0.000000730719481", "71428571428571350000000", "52194248642857100"},
				[]string{"0.000000182688572", "71428571428571350000000", "13049183714285700"},
				[]string{"0.000000913289559", "71428571428571350000000", "65234968499999900"},
				[]string{"0.000001826644113", "71428571428571350000000", "130474579500000000"},
				[]string{"0.000000182671879", "71428571428571350000000", "13047991357142800"},
				[]string{"0.000000182662499", "71428571428571350000000", "13047321357142800"},
				[]string{"0.000000365352705", "71428571428571350000000", "26096621785714300"},
				[]string{"0.000000182705292", "71428571428571350000000", "13050378000000000"},
				[]string{"0.00000018267561", "71428571428571350000000", "13048257857142800"},
				[]string{"0.000000363500629", "71428571428571350000000", "25964330642857100"},
				[]string{"0.000000182664822", "71428571428571350000000", "13047487285714300"},
				[]string{"0.000001004711624", "71428571428571350000000", "71765115999999900"},
				[]string{"0.000000182685769", "71428571428571350000000", "13048983500000000"},
				[]string{"0.000000091335153", "71428571428571350000000", "6523939499999990"},
				[]string{"0.000000200927655", "71428571428571350000000", "14351975357142800"},
				[]string{"0.00000018267561", "71428571428571350000000", "13048257857142800"},
				[]string{"0.000000182698286", "71428571428571350000000", "13049877571428600"},
				[]string{"0.000001826621546", "71428571428571350000000", "130472967571428000"},
				[]string{"0.000001644257716", "71428571428571350000000", "117446979714286000"},
				[]string{"0.000000730781207", "71428571428571350000000", "52198657642857100"},
				[]string{"0.000002369608877", "71428571428571350000000", "169257776928571000"},
				[]string{"0.000000182685769", "71428571428571350000000", "13048983500000000"},
				[]string{"0.000005845092031", "71428571428571350000000", "417506573642857000"},
				[]string{"0.000000365351989", "71428571428571350000000", "26096570642857100"},
				[]string{"0.000001826900944", "71428571428571350000000", "130492924571428000"},
				[]string{"0.000000182684202", "71428571428571350000000", "13048871571428600"},
				[]string{"0.00000018267987", "71428571428571350000000", "13048562142857100"},
				[]string{"0.000000009133515", "71428571428571350000000", "652393928571428"},
				[]string{"0.000000182698286", "71428571428571350000000", "13049877571428600"},
				[]string{"0.00000018267561", "71428571428571350000000", "13048257857142800"},
				[]string{"0.00000054801092", "71428571428571350000000", "39143637142857100"},
			}

			s := NewSqlite(&SqliteConfig{
				Path:           SqliteInMemoryPath,
				ExtensionsPath: []string{tests.GetSqliteExtensionsPath()},
			}, l)
			grm, err := NewGormSqliteFromSqlite(s)
			assert.Nil(t, err)

			for _, v := range values {
				stakerProportion := v[0]
				tokensPerDay := v[1]
				expectedResult := v[2]

				query := `select nile_staker_token_rewards(@stakerProportion, @tokensPerDay) as amt`

				var result string
				res := grm.Raw(query, sql.Named("stakerProportion", stakerProportion), sql.Named("tokensPerDay", tokensPerDay)).Scan(&result)
				assert.Nil(t, res.Error)

				//expected, _ := decimal.NewFromString(expectedResult)
				//actual, _ := decimal.NewFromString(result)

				assert.Equal(t, expectedResult, result, "stakerProportion: %s, tokensPerDay: %s", stakerProportion, tokensPerDay)
			}
		})
		t.Run("Should call staker_token_rewards", func(t *testing.T) {
			values := [][]string{
				[]string{"0.00000327533587", "178571428571428571", "584881405357"},
				[]string{"0.000000141845238", "178571428571428571", "25329506785"},
				[]string{"0.000082782743848", "178571428571428571", "14782632829999"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000001737682251", "178571428571428571", "310300401964"},
				[]string{"0.000003734712825", "178571428571428571", "666913004464"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000000141845238", "178571428571428571", "25329506785"},
				[]string{"0.000000141845238", "178571428571428571", "25329506785"},
				[]string{"0.000003797184132", "178571428571428571", "678068594999"},
				[]string{"0.000001967716253", "178571428571428571", "351377902321"},
				[]string{"0.000000141845238", "178571428571428571", "25329506785"},
				[]string{"0.000005869555747", "178571428571428571", "1048134954821"},
				[]string{"0.000087545166967", "178571428571428571", "15633065529821"},
				[]string{"0.000003127399087", "178571428571428571", "558464122678"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.00000257511391", "178571428571428571", "459841769642"},
				[]string{"0.000003146687911", "178571428571428571", "561908555535"},
				[]string{"0.000001815619057", "178571428571428571", "324217688749"},
				[]string{"0.000001698667661", "178571428571428571", "303333510892"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000000141845238", "178571428571428571", "25329506785"},
				[]string{"0.000001744696437", "178571428571428571", "311552935178"},
				[]string{"0.000000028369047", "178571428571428571", "5065901249"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000004005520613", "178571428571428571", "715271538035"},
				[]string{"0.000002057288123", "178571428571428571", "367372879107"},
				[]string{"0.000001921085712", "178571428571428571", "343051019999"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000002190535979", "178571428571428571", "391167139107"},
				[]string{"0.00000249623368", "178571428571428571", "445756014285"},
				[]string{"0.000002723159231", "178571428571428571", "486278434107"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000004005751654", "178571428571428571", "715312795357"},
				[]string{"0.000002564599235", "178571428571428571", "457964149107"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000004645205202", "178571428571428571", "829500928928"},
				[]string{"0.000001609076855", "178571428571428571", "287335152678"},
				[]string{"0.000004004850346", "178571428571428571", "715151847499"},
				[]string{"0.000001819042992", "178571428571428571", "324829105714"},
				[]string{"0.000001898334381", "178571428571428571", "338988282321"},
				[]string{"0.000009083677345", "178571428571428571", "1622085240178"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000002137676139", "178571428571428571", "381727881964"},
				[]string{"0.000000896637483", "178571428571428571", "160113836249"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000003404285731", "178571428571428571", "607908166249"},
				[]string{"0.000001589648367", "178571428571428571", "283865779821"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000047573796208", "178571428571428571", "8495320751428"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.00000169535044", "178571428571428571", "302741149999"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000003133523199", "178571428571428571", "559557714107"},
				[]string{"0.000003031791259", "178571428571428571", "541391296249"},
				[]string{"0.000002826231912", "178571428571428571", "504684269999"},
				[]string{"0.000004351664667", "178571428571428571", "777082976249"},
				[]string{"0.000002097623983", "178571428571428571", "374575711249"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.00000267905624", "178571428571428571", "478402899999"},
				[]string{"0.000002032159275", "178571428571428571", "362885584821"},
				[]string{"0.000001418452388", "178571428571428571", "253295069285"},
				[]string{"0.000001571877069", "178571428571428571", "280692333749"},
				[]string{"0.000001772354832", "178571428571428571", "316491934285"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000001627620005", "178571428571428571", "290646429464"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000001954294228", "178571428571428571", "348981112142"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000059257402807", "178571428571428571", "10581679072678"},
				[]string{"0.000001712443026", "178571428571428571", "305793397499"},
				[]string{"0.000001986868624", "178571428571428571", "354797968571"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000001621847466", "178571428571428571", "289615618928"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000003655514861", "178571428571428571", "652770510892"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000003625699748", "178571428571428571", "647446383571"},
				[]string{"0.000001418452388", "178571428571428571", "253295069285"},
				[]string{"0.000001692836614", "178571428571428571", "302292252499"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000001828628233", "178571428571428571", "326540755892"},
				[]string{"0.000001727076242", "178571428571428571", "308406471785"},
				[]string{"0.00000220284214", "178571428571428571", "393364667857"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
				[]string{"0.000001606835234", "178571428571428571", "286934863214"},
				[]string{"0.000001748772999", "178571428571428571", "312280892678"},
				[]string{"0.000002453818313", "178571428571428571", "438181841607"},
				[]string{"0.000001560297627", "178571428571428571", "278624576249"},
			}

			s := NewSqlite(&SqliteConfig{
				Path:           SqliteInMemoryPath,
				ExtensionsPath: []string{tests.GetSqliteExtensionsPath()},
			}, l)
			grm, err := NewGormSqliteFromSqlite(s)
			assert.Nil(t, err)

			for _, v := range values {
				stakerProportion := v[0]
				tokensPerDay := v[1]
				expectedResult := v[2]

				query := `select staker_token_rewards(@stakerProportion, @tokensPerDay) as amt`

				var result string
				res := grm.Raw(query, sql.Named("stakerProportion", stakerProportion), sql.Named("tokensPerDay", tokensPerDay)).Scan(&result)
				assert.Nil(t, res.Error)

				//expected, _ := decimal.NewFromString(expectedResult)
				//actual, _ := decimal.NewFromString(result)
				goRes, _ := numbers.StakerTokenRewards(stakerProportion, tokensPerDay)

				assert.Equal(t, expectedResult, result, "stakerProportion: %s, tokensPerDay: %s go result: %s", stakerProportion, tokensPerDay, goRes)
			}
		})
		t.Run("Should call amazon_operator_token_rewards", func(t *testing.T) {
			// t.Skip("what")
			values := [][]string{
				[]string{"13167642495403300000000", "1316764249540330000000"},
				[]string{"48660996099751700000000", "4866099609975170000000"},
				[]string{"21295670860665800000000", "2129567086066580000000"},
				[]string{"59732833401321600000000", "5973283340132160000000"},
				[]string{"13167642495403300000000", "1316764249540330000000"},
				[]string{"48660996099751700000000", "4866099609975170000000"},
				[]string{"21295670860665800000000", "2129567086066580000000"},
				[]string{"59732833401321600000000", "5973283340132160000000"},
				[]string{"13167642495403300000000", "1316764249540330000000"},
				[]string{"48660996099751700000000", "4866099609975170000000"},
				[]string{"21295670860665800000000", "2129567086066580000000"},
				[]string{"59732833401321600000000", "5973283340132160000000"},
				[]string{"13167642495403300000000", "1316764249540330000000"},
				[]string{"48660996099751700000000", "4866099609975170000000"},
				[]string{"21295670860665800000000", "2129567086066580000000"},
				[]string{"59732833401321600000000", "5973283340132160000000"},
				[]string{"13167642495403300000000", "1316764249540330000000"},
				[]string{"48660996099751700000000", "4866099609975170000000"},
				[]string{"21295670860665800000000", "2129567086066580000000"},
				[]string{"59732833401321600000000", "5973283340132160000000"},
				[]string{"13167642495403300000000", "1316764249540330000000"},
				[]string{"48660996099751700000000", "4866099609975170000000"},
				[]string{"21295670860665800000000", "2129567086066580000000"},
				[]string{"59732833401321600000000", "5973283340132160000000"},
				[]string{"13167642495403300000000", "1316764249540330000000"},
				[]string{"48660996099751700000000", "4866099609975170000000"},
				[]string{"21295670860665800000000", "2129567086066580000000"},
				[]string{"59732833401321600000000", "5973283340132160000000"},
			}

			s := NewSqlite(&SqliteConfig{
				Path:           SqliteInMemoryPath,
				ExtensionsPath: []string{tests.GetSqliteExtensionsPath()},
			}, l)
			grm, err := NewGormSqliteFromSqlite(s)
			assert.Nil(t, err)

			for _, v := range values {
				totalStakerOperatorPayout := v[0]
				expectedResult := v[1]

				query := `select amazon_operator_token_rewards(@totalStakerOperatorPayout) as amt`
				var result string
				res := grm.Raw(query, sql.Named("totalStakerOperatorPayout", totalStakerOperatorPayout)).Scan(&result)
				assert.Nil(t, res.Error)

				assert.Equal(t, expectedResult, result, "totalStakerOperatorPayout: %s", totalStakerOperatorPayout)
			}
		})
		t.Run("Should call nile_operator_token_rewards", func(t *testing.T) {
			values := [][]string{[]string{"17169644785714300", "1716964478571430"},
				[]string{"13047198500000000", "1304719850000000"},
				[]string{"13045523500000000", "1304552350000000"},
				[]string{"247865428857143000", "24786542885714300"},
				[]string{"1565636357214280000", "156563635721428000"},
				[]string{"260967146714285000", "26096714671428500"},
				[]string{"65248491499999900", "6524849149999990"},
				[]string{"930521285714285", "93052128571429"},
				[]string{"182449737714286000", "18244973771428600"},
				[]string{"130482029071428000", "13048202907142800"},
				[]string{"130499930214286000", "13049993021428600"},
				[]string{"13048257857142800", "1304825785714280"},
				[]string{"13048983500000000", "1304898350000000"},
				[]string{"169019626857143000", "16901962685714300"},
				[]string{"117414669285714000", "11741466928571400"},
				[]string{"26440635500000000", "2644063550000000"},
				[]string{"13049376500000000", "1304937650000000"},
				[]string{"26094500642857100", "2609450064285710"},
				[]string{"13048357285714300", "1304835728571430"},
				[]string{"13050195500000000", "1305019550000000"},
				[]string{"13048357285714300", "1304835728571430"},
				[]string{"1304984642857140", "130498464285714"},
				[]string{"13048709857142800", "1304870985714280"},
				[]string{"141955417500000000", "14195541750000000"},
				[]string{"3000922071428570", "300092207142857"},
				[]string{"52185529642857100", "5218552964285710"},
				[]string{"13048357285714300", "1304835728571430"},
				[]string{"2818366071428570", "281836607142857"},
				[]string{"26097798857142800", "2609779885714280"},
				[]string{"13048409000000000", "1304840900000000"},
				[]string{"22183750214285700", "2218375021428570"},
				[]string{"301922043857143000", "30192204385714300"},
				[]string{"26101226285714300", "2610122628571430"},
				[]string{"12656113714285700", "1265611371428570"},
				[]string{"117422683428571000", "11742268342857100"},
				[]string{"13048154285714300", "1304815428571430"},
				[]string{"195747262928571000", "19574726292857100"},
				[]string{"182674785714286", "18267478571429"},
				[]string{"130468357142857000", "13046835714285700"},
				[]string{"11742086500000000", "1174208650000000"},
				[]string{"195713099071428000", "19571309907142800"},
				[]string{"2609507928571430", "260950792857143"},
				[]string{"13047991357142800", "1304799135714280"},
				[]string{"6522099071428560", "652209907142856"},
				[]string{"13047879000000000", "1304787900000000"},
				[]string{"521842974785714000", "52184297478571400"},
				[]string{"13049292428571400", "1304929242857140"},
				[]string{"339268554000000000", "33926855400000000"},
				[]string{"13597189214285700", "1359718921428570"},
				[]string{"13048017285714300", "1304801728571430"},
				[]string{"26094865214285700", "2609486521428570"},
				[]string{"195708754857143000", "19570875485714300"},
				[]string{"13047146857142800", "1304714685714280"},
				[]string{"4436865714285710", "443686571428571"},
				[]string{"3540610642857140", "354061064285714"},
				[]string{"65249233357142800", "6524923335714280"},
				[]string{"13041462642857100", "1304146264285710"},
				[]string{"117425252928571000", "11742525292857100"},
				[]string{"13047903642857100", "1304790364285710"},
				[]string{"1304981714285710", "130498171428571"},
				[]string{"26251544428571400", "2625154442857140"},
				[]string{"521896071428571", "52189607142857"},
				[]string{"13047879000000000", "1304787900000000"},
				[]string{"1304987714285710", "130498771428571"},
				[]string{"11743816857142800", "1174381685714280"},
				[]string{"1983200642857140", "198320064285714"},
				[]string{"28711056357142800", "2871105635714280"},
				[]string{"8873838142857130", "887383814285713"},
				[]string{"34447663357142800", "3444766335714280"},
				[]string{"52194248642857100", "5219424864285710"},
				[]string{"13049183714285700", "1304918371428570"},
				[]string{"65234968499999900", "6523496849999990"},
				[]string{"130474579500000000", "13047457950000000"},
				[]string{"13047991357142800", "1304799135714280"},
				[]string{"13047321357142800", "1304732135714280"},
				[]string{"26096621785714300", "2609662178571430"},
				[]string{"13050378000000000", "1305037800000000"},
				[]string{"13048257857142800", "1304825785714280"},
				[]string{"25964330642857100", "2596433064285710"},
				[]string{"13047487285714300", "1304748728571430"},
				[]string{"71765115999999900", "7176511599999990"},
				[]string{"13048983500000000", "1304898350000000"},
				[]string{"6523939499999990", "652393949999999"},
				[]string{"14351975357142800", "1435197535714280"},
				[]string{"13048257857142800", "1304825785714280"},
				[]string{"13049877571428600", "1304987757142860"},
				[]string{"130472967571428000", "13047296757142800"},
				[]string{"117446979714286000", "11744697971428600"},
				[]string{"52198657642857100", "5219865764285710"},
				[]string{"169257776928571000", "16925777692857100"},
				[]string{"13048983500000000", "1304898350000000"},
				[]string{"417506573642857000", "41750657364285700"},
				[]string{"26096570642857100", "2609657064285710"},
				[]string{"130492924571428000", "13049292457142800"},
				[]string{"13048871571428600", "1304887157142860"},
				[]string{"13048562142857100", "1304856214285710"},
				[]string{"652393928571428", "65239392857143"},
				[]string{"13049877571428600", "1304987757142860"},
				[]string{"13048257857142800", "1304825785714280"},
				[]string{"39143637142857100", "3914363714285710"},
			}

			s := NewSqlite(&SqliteConfig{
				Path:           SqliteInMemoryPath,
				ExtensionsPath: []string{tests.GetSqliteExtensionsPath()},
			}, l)
			grm, err := NewGormSqliteFromSqlite(s)
			assert.Nil(t, err)

			for _, v := range values {
				totalStakerOperatorPayout := v[0]
				expectedResult := v[1]

				query := `select nile_operator_token_rewards(@totalStakerOperatorPayout) as amt`
				var result string
				res := grm.Raw(query, sql.Named("totalStakerOperatorPayout", totalStakerOperatorPayout)).Scan(&result)
				assert.Nil(t, res.Error)

				assert.Equal(t, expectedResult, result, "totalStakerOperatorPayout: %s", totalStakerOperatorPayout)
			}
		})
		t.Run("Should call operator_token_rewards", func(t *testing.T) {
			values := [][]string{
				[]string{"584881405357", "58488140535"},
				[]string{"25329506785", "2532950678"},
				[]string{"14782632829999", "1478263282999"},
				[]string{"278624576249", "27862457624"},
				[]string{"310300401964", "31030040196"},
				[]string{"666913004464", "66691300446"},
				[]string{"278624576249", "27862457624"},
				[]string{"25329506785", "2532950678"},
				[]string{"25329506785", "2532950678"},
				[]string{"678068594999", "67806859499"},
				[]string{"351377902321", "35137790232"},
				[]string{"25329506785", "2532950678"},
				[]string{"1048134954821", "104813495482"},
				[]string{"15633065529821", "1563306552982"},
				[]string{"558464122678", "55846412267"},
				[]string{"278624576249", "27862457624"},
				[]string{"459841769642", "45984176964"},
				[]string{"561908555535", "56190855553"},
				[]string{"324217688749", "32421768874"},
				[]string{"303333510892", "30333351089"},
				[]string{"278624576249", "27862457624"},
				[]string{"278624576249", "27862457624"},
				[]string{"25329506785", "2532950678"},
				[]string{"311552935178", "31155293517"},
				[]string{"5065901249", "506590124"},
				[]string{"278624576249", "27862457624"},
				[]string{"278624576249", "27862457624"},
				[]string{"715271538035", "71527153803"},
				[]string{"367372879107", "36737287910"},
				[]string{"343051019999", "34305101999"},
				[]string{"278624576249", "27862457624"},
				[]string{"278624576249", "27862457624"},
				[]string{"278624576249", "27862457624"},
				[]string{"391167139107", "39116713910"},
				[]string{"445756014285", "44575601428"},
				[]string{"486278434107", "48627843410"},
				[]string{"278624576249", "27862457624"},
				[]string{"278624576249", "27862457624"},
				[]string{"715312795357", "71531279535"},
				[]string{"457964149107", "45796414910"},
				[]string{"278624576249", "27862457624"},
				[]string{"829500928928", "82950092892"},
				[]string{"287335152678", "28733515267"},
				[]string{"715151847499", "71515184749"},
				[]string{"324829105714", "32482910571"},
				[]string{"338988282321", "33898828232"},
				[]string{"1622085240178", "162208524017"},
				[]string{"278624576249", "27862457624"},
				[]string{"278624576249", "27862457624"},
				[]string{"381727881964", "38172788196"},
				[]string{"160113836249", "16011383624"},
				[]string{"278624576249", "27862457624"},
				[]string{"607908166249", "60790816624"},
				[]string{"283865779821", "28386577982"},
				[]string{"278624576249", "27862457624"},
				[]string{"8495320751428", "849532075142"},
				[]string{"278624576249", "27862457624"},
				[]string{"302741149999", "30274114999"},
				[]string{"278624576249", "27862457624"},
				[]string{"278624576249", "27862457624"},
				[]string{"278624576249", "27862457624"},
				[]string{"559557714107", "55955771410"},
				[]string{"541391296249", "54139129624"},
				[]string{"504684269999", "50468426999"},
				[]string{"777082976249", "77708297624"},
				[]string{"374575711249", "37457571124"},
				[]string{"278624576249", "27862457624"},
				[]string{"478402899999", "47840289999"},
				[]string{"362885584821", "36288558482"},
				[]string{"253295069285", "25329506928"},
				[]string{"280692333749", "28069233374"},
				[]string{"316491934285", "31649193428"},
				[]string{"278624576249", "27862457624"},
				[]string{"278624576249", "27862457624"},
				[]string{"278624576249", "27862457624"},
				[]string{"290646429464", "29064642946"},
				[]string{"278624576249", "27862457624"},
				[]string{"348981112142", "34898111214"},
				[]string{"278624576249", "27862457624"},
				[]string{"10581679072678", "1058167907267"},
				[]string{"305793397499", "30579339749"},
				[]string{"354797968571", "35479796857"},
				[]string{"278624576249", "27862457624"},
				[]string{"289615618928", "28961561892"},
				[]string{"278624576249", "27862457624"},
				[]string{"652770510892", "65277051089"},
				[]string{"278624576249", "27862457624"},
				[]string{"278624576249", "27862457624"},
				[]string{"647446383571", "64744638357"},
				[]string{"253295069285", "25329506928"},
				[]string{"302292252499", "30229225249"},
				[]string{"278624576249", "27862457624"},
				[]string{"326540755892", "32654075589"},
				[]string{"308406471785", "30840647178"},
				[]string{"393364667857", "39336466785"},
				[]string{"278624576249", "27862457624"},
				[]string{"286934863214", "28693486321"},
				[]string{"312280892678", "31228089267"},
				[]string{"438181841607", "43818184160"},
				[]string{"278624576249", "27862457624"},
			}

			s := NewSqlite(&SqliteConfig{
				Path:           SqliteInMemoryPath,
				ExtensionsPath: []string{tests.GetSqliteExtensionsPath()},
			}, l)
			grm, err := NewGormSqliteFromSqlite(s)
			assert.Nil(t, err)

			for _, v := range values {
				totalStakerOperatorPayout := v[0]
				expectedResult := v[1]

				query := `select operator_token_rewards(@totalStakerOperatorPayout) as amt`
				var result string
				res := grm.Raw(query, sql.Named("totalStakerOperatorPayout", totalStakerOperatorPayout)).Scan(&result)
				assert.Nil(t, res.Error)

				assert.Equal(t, expectedResult, result, "totalStakerOperatorPayout: %s", totalStakerOperatorPayout)
			}
		})
		t.Run("Should call big_subtract to determine amazon staker token total", func(t *testing.T) {
			t.Skip("Implement me")
			values := [][]string{
				[]string{"13167642495403300000000", "1316764249540330000000", "11850878245862970000000"},
				[]string{"48660996099751700000000", "4866099609975170000000", "43794896489776530000000"},
				[]string{"21295670860665800000000", "2129567086066580000000", "19166103774599220000000"},
				[]string{"59732833401321600000000", "5973283340132160000000", "53759550061189440000000"},
				[]string{"13167642495403300000000", "1316764249540330000000", "11850878245862970000000"},
				[]string{"48660996099751700000000", "4866099609975170000000", "43794896489776530000000"},
				[]string{"21295670860665800000000", "2129567086066580000000", "19166103774599220000000"},
				[]string{"59732833401321600000000", "5973283340132160000000", "53759550061189440000000"},
				[]string{"13167642495403300000000", "1316764249540330000000", "11850878245862970000000"},
				[]string{"48660996099751700000000", "4866099609975170000000", "43794896489776530000000"},
				[]string{"21295670860665800000000", "2129567086066580000000", "19166103774599220000000"},
				[]string{"59732833401321600000000", "5973283340132160000000", "53759550061189440000000"},
				[]string{"13167642495403300000000", "1316764249540330000000", "11850878245862970000000"},
				[]string{"48660996099751700000000", "4866099609975170000000", "43794896489776530000000"},
				[]string{"21295670860665800000000", "2129567086066580000000", "19166103774599220000000"},
				[]string{"59732833401321600000000", "5973283340132160000000", "53759550061189440000000"},
				[]string{"13167642495403300000000", "1316764249540330000000", "11850878245862970000000"},
				[]string{"48660996099751700000000", "4866099609975170000000", "43794896489776530000000"},
				[]string{"21295670860665800000000", "2129567086066580000000", "19166103774599220000000"},
				[]string{"59732833401321600000000", "5973283340132160000000", "53759550061189440000000"},
				[]string{"13167642495403300000000", "1316764249540330000000", "11850878245862970000000"},
				[]string{"48660996099751700000000", "4866099609975170000000", "43794896489776530000000"},
				[]string{"21295670860665800000000", "2129567086066580000000", "19166103774599220000000"},
				[]string{"59732833401321600000000", "5973283340132160000000", "53759550061189440000000"},
				[]string{"13167642495403300000000", "1316764249540330000000", "11850878245862970000000"},
				[]string{"48660996099751700000000", "4866099609975170000000", "43794896489776530000000"},
				[]string{"21295670860665800000000", "2129567086066580000000", "19166103774599220000000"},
				[]string{"59732833401321600000000", "5973283340132160000000", "53759550061189440000000"},
			}

			s := NewSqlite(&SqliteConfig{
				Path:           SqliteInMemoryPath,
				ExtensionsPath: []string{tests.GetSqliteExtensionsPath()},
			}, l)
			grm, err := NewGormSqliteFromSqlite(s)
			assert.Nil(t, err)

			for _, v := range values {
				totalStakerOperatorPayout := v[0]
				operatorTokens := v[1]
				expectedResult := v[2]

				query := `select subtract_big(@totalStakerOperatorPayout, @operatorTokens) as amt`
				var result string
				res := grm.Raw(query, sql.Named("totalStakerOperatorPayout", totalStakerOperatorPayout), sql.Named("operatorTokens", operatorTokens)).Scan(&result)
				assert.Nil(t, res.Error)

				assert.Equal(t, expectedResult, result, "totalStakerOperatorPayout: %s", totalStakerOperatorPayout)
			}
		})
		t.Run("Should call big_subtract to determine nile staker token total", func(t *testing.T) {
			t.Skip("Implement me")
			values := [][]string{
				[]string{"17169644785714300", "1716964478571430", "15452680307142870"},
				[]string{"13047198500000000", "1304719850000000", "11742478650000000"},
				[]string{"13045523500000000", "1304552350000000", "11740971150000000"},
				[]string{"247865428857143000", "24786542885714300", "223078885971428700"},
				[]string{"1565636357214280000", "156563635721428000", "1409072721492852000"},
				[]string{"260967146714285000", "26096714671428500", "234870432042856500"},
				[]string{"65248491499999900", "6524849149999990", "58723642349999910"},
				[]string{"930521285714285", "93052128571429", "837469157142856"},
				[]string{"182449737714286000", "18244973771428600", "164204763942857400"},
				[]string{"130482029071428000", "13048202907142800", "117433826164285200"},
				[]string{"130499930214286000", "13049993021428600", "117449937192857400"},
				[]string{"13048257857142800", "1304825785714280", "11743432071428520"},
				[]string{"13048983500000000", "1304898350000000", "11744085150000000"},
				[]string{"169019626857143000", "16901962685714300", "152117664171428700"},
				[]string{"117414669285714000", "11741466928571400", "105673202357142600"},
				[]string{"26440635500000000", "2644063550000000", "23796571950000000"},
				[]string{"13049376500000000", "1304937650000000", "11744438850000000"},
				[]string{"26094500642857100", "2609450064285710", "23485050578571390"},
				[]string{"13048357285714300", "1304835728571430", "11743521557142870"},
				[]string{"13050195500000000", "1305019550000000", "11745175950000000"},
				[]string{"13048357285714300", "1304835728571430", "11743521557142870"},
				[]string{"1304984642857140", "130498464285714", "1174486178571426"},
				[]string{"13048709857142800", "1304870985714280", "11743838871428520"},
				[]string{"141955417500000000", "14195541750000000", "127759875750000000"},
				[]string{"3000922071428570", "300092207142857", "2700829864285713"},
				[]string{"52185529642857100", "5218552964285710", "46966976678571390"},
				[]string{"13048357285714300", "1304835728571430", "11743521557142870"},
				[]string{"2818366071428570", "281836607142857", "2536529464285713"},
				[]string{"26097798857142800", "2609779885714280", "23488018971428520"},
				[]string{"13048409000000000", "1304840900000000", "11743568100000000"},
				[]string{"22183750214285700", "2218375021428570", "19965375192857130"},
				[]string{"301922043857143000", "30192204385714300", "271729839471428700"},
				[]string{"26101226285714300", "2610122628571430", "23491103657142870"},
				[]string{"12656113714285700", "1265611371428570", "11390502342857130"},
				[]string{"117422683428571000", "11742268342857100", "105680415085713900"},
				[]string{"13048154285714300", "1304815428571430", "11743338857142870"},
				[]string{"195747262928571000", "19574726292857100", "176172536635713900"},
				[]string{"182674785714286", "18267478571429", "164407307142857"},
				[]string{"130468357142857000", "13046835714285700", "117421521428571300"},
				[]string{"11742086500000000", "1174208650000000", "10567877850000000"},
				[]string{"195713099071428000", "19571309907142800", "176141789164285200"},
				[]string{"2609507928571430", "260950792857143", "2348557135714287"},
				[]string{"13047991357142800", "1304799135714280", "11743192221428520"},
				[]string{"6522099071428560", "652209907142856", "5869889164285704"},
				[]string{"13047879000000000", "1304787900000000", "11743091100000000"},
				[]string{"521842974785714000", "52184297478571400", "469658677307142600"},
				[]string{"13049292428571400", "1304929242857140", "11744363185714260"},
				[]string{"339268554000000000", "33926855400000000", "305341698600000000"},
				[]string{"13597189214285700", "1359718921428570", "12237470292857130"},
				[]string{"13048017285714300", "1304801728571430", "11743215557142870"},
				[]string{"26094865214285700", "2609486521428570", "23485378692857130"},
				[]string{"195708754857143000", "19570875485714300", "176137879371428700"},
				[]string{"13047146857142800", "1304714685714280", "11742432171428520"},
				[]string{"4436865714285710", "443686571428571", "3993179142857139"},
				[]string{"3540610642857140", "354061064285714", "3186549578571426"},
				[]string{"65249233357142800", "6524923335714280", "58724310021428520"},
				[]string{"13041462642857100", "1304146264285710", "11737316378571390"},
				[]string{"117425252928571000", "11742525292857100", "105682727635713900"},
				[]string{"13047903642857100", "1304790364285710", "11743113278571390"},
				[]string{"1304981714285710", "130498171428571", "1174483542857139"},
				[]string{"26251544428571400", "2625154442857140", "23626389985714260"},
				[]string{"521896071428571", "52189607142857", "469706464285714"},
				[]string{"13047879000000000", "1304787900000000", "11743091100000000"},
				[]string{"1304987714285710", "130498771428571", "1174488942857139"},
				[]string{"11743816857142800", "1174381685714280", "10569435171428520"},
				[]string{"1983200642857140", "198320064285714", "1784880578571426"},
				[]string{"28711056357142800", "2871105635714280", "25839950721428520"},
				[]string{"8873838142857130", "887383814285713", "7986454328571417"},
				[]string{"34447663357142800", "3444766335714280", "31002897021428520"},
				[]string{"52194248642857100", "5219424864285710", "46974823778571390"},
				[]string{"13049183714285700", "1304918371428570", "11744265342857130"},
				[]string{"65234968499999900", "6523496849999990", "58711471649999910"},
				[]string{"130474579500000000", "13047457950000000", "117427121550000000"},
				[]string{"13047991357142800", "1304799135714280", "11743192221428520"},
				[]string{"13047321357142800", "1304732135714280", "11742589221428520"},
				[]string{"26096621785714300", "2609662178571430", "23486959607142870"},
				[]string{"13050378000000000", "1305037800000000", "11745340200000000"},
				[]string{"13048257857142800", "1304825785714280", "11743432071428520"},
				[]string{"25964330642857100", "2596433064285710", "23367897578571390"},
				[]string{"13047487285714300", "1304748728571430", "11742738557142870"},
				[]string{"71765115999999900", "7176511599999990", "64588604399999910"},
				[]string{"13048983500000000", "1304898350000000", "11744085150000000"},
				[]string{"6523939499999990", "652393949999999", "5871545549999991"},
				[]string{"14351975357142800", "1435197535714280", "12916777821428520"},
				[]string{"13048257857142800", "1304825785714280", "11743432071428520"},
				[]string{"13049877571428600", "1304987757142860", "11744889814285740"},
				[]string{"130472967571428000", "13047296757142800", "117425670814285200"},
				[]string{"117446979714286000", "11744697971428600", "105702281742857400"},
				[]string{"52198657642857100", "5219865764285710", "46978791878571390"},
				[]string{"169257776928571000", "16925777692857100", "152331999235713900"},
				[]string{"13048983500000000", "1304898350000000", "11744085150000000"},
				[]string{"417506573642857000", "41750657364285700", "375755916278571300"},
				[]string{"26096570642857100", "2609657064285710", "23486913578571390"},
				[]string{"130492924571428000", "13049292457142800", "117443632114285200"},
				[]string{"13048871571428600", "1304887157142860", "11743984414285740"},
				[]string{"13048562142857100", "1304856214285710", "11743705928571390"},
				[]string{"652393928571428", "65239392857143", "587154535714285"},
				[]string{"13049877571428600", "1304987757142860", "11744889814285740"},
				[]string{"13048257857142800", "1304825785714280", "11743432071428520"},
				[]string{"39143637142857100", "3914363714285710", "35229273428571390"},
			}

			s := NewSqlite(&SqliteConfig{
				Path:           SqliteInMemoryPath,
				ExtensionsPath: []string{tests.GetSqliteExtensionsPath()},
			}, l)
			grm, err := NewGormSqliteFromSqlite(s)
			assert.Nil(t, err)

			for _, v := range values {
				totalStakerOperatorPayout := v[0]
				operatorTokens := v[1]
				expectedResult := v[2]

				query := `select subtract_big(@totalStakerOperatorPayout, @operatorTokens) as amt`
				var result string
				res := grm.Raw(query, sql.Named("totalStakerOperatorPayout", totalStakerOperatorPayout), sql.Named("operatorTokens", operatorTokens)).Scan(&result)
				assert.Nil(t, res.Error)

				assert.Equal(t, expectedResult, result, "totalStakerOperatorPayout: %s", totalStakerOperatorPayout)
			}
		})
		t.Run("Should call big_subtract to determine post-nile staker token total", func(t *testing.T) {
			t.Skip("Implement me")
			values := [][]string{
				[]string{"584881405357", "58488140535", "526393264822"},
				[]string{"25329506785", "2532950678", "22796556107"},
				[]string{"14782632829999", "1478263282999", "13304369547000"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"310300401964", "31030040196", "279270361768"},
				[]string{"666913004464", "66691300446", "600221704018"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"25329506785", "2532950678", "22796556107"},
				[]string{"25329506785", "2532950678", "22796556107"},
				[]string{"678068594999", "67806859499", "610261735500"},
				[]string{"351377902321", "35137790232", "316240112089"},
				[]string{"25329506785", "2532950678", "22796556107"},
				[]string{"1048134954821", "104813495482", "943321459339"},
				[]string{"15633065529821", "1563306552982", "14069758976839"},
				[]string{"558464122678", "55846412267", "502617710411"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"459841769642", "45984176964", "413857592678"},
				[]string{"561908555535", "56190855553", "505717699982"},
				[]string{"324217688749", "32421768874", "291795919875"},
				[]string{"303333510892", "30333351089", "273000159803"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"25329506785", "2532950678", "22796556107"},
				[]string{"311552935178", "31155293517", "280397641661"},
				[]string{"5065901249", "506590124", "4559311125"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"715271538035", "71527153803", "643744384232"},
				[]string{"367372879107", "36737287910", "330635591197"},
				[]string{"343051019999", "34305101999", "308745918000"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"391167139107", "39116713910", "352050425197"},
				[]string{"445756014285", "44575601428", "401180412857"},
				[]string{"486278434107", "48627843410", "437650590697"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"715312795357", "71531279535", "643781515822"},
				[]string{"457964149107", "45796414910", "412167734197"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"829500928928", "82950092892", "746550836036"},
				[]string{"287335152678", "28733515267", "258601637411"},
				[]string{"715151847499", "71515184749", "643636662750"},
				[]string{"324829105714", "32482910571", "292346195143"},
				[]string{"338988282321", "33898828232", "305089454089"},
				[]string{"1622085240178", "162208524017", "1459876716161"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"381727881964", "38172788196", "343555093768"},
				[]string{"160113836249", "16011383624", "144102452625"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"607908166249", "60790816624", "547117349625"},
				[]string{"283865779821", "28386577982", "255479201839"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"8495320751428", "849532075142", "7645788676286"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"302741149999", "30274114999", "272467035000"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"559557714107", "55955771410", "503601942697"},
				[]string{"541391296249", "54139129624", "487252166625"},
				[]string{"504684269999", "50468426999", "454215843000"},
				[]string{"777082976249", "77708297624", "699374678625"},
				[]string{"374575711249", "37457571124", "337118140125"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"478402899999", "47840289999", "430562610000"},
				[]string{"362885584821", "36288558482", "326597026339"},
				[]string{"253295069285", "25329506928", "227965562357"},
				[]string{"280692333749", "28069233374", "252623100375"},
				[]string{"316491934285", "31649193428", "284842740857"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"290646429464", "29064642946", "261581786518"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"348981112142", "34898111214", "314083000928"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"10581679072678", "1058167907267", "9523511165411"},
				[]string{"305793397499", "30579339749", "275214057750"},
				[]string{"354797968571", "35479796857", "319318171714"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"289615618928", "28961561892", "260654057036"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"652770510892", "65277051089", "587493459803"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"647446383571", "64744638357", "582701745214"},
				[]string{"253295069285", "25329506928", "227965562357"},
				[]string{"302292252499", "30229225249", "272063027250"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"326540755892", "32654075589", "293886680303"},
				[]string{"308406471785", "30840647178", "277565824607"},
				[]string{"393364667857", "39336466785", "354028201072"},
				[]string{"278624576249", "27862457624", "250762118625"},
				[]string{"286934863214", "28693486321", "258241376893"},
				[]string{"312280892678", "31228089267", "281052803411"},
				[]string{"438181841607", "43818184160", "394363657447"},
				[]string{"278624576249", "27862457624", "250762118625"},
			}

			s := NewSqlite(&SqliteConfig{
				Path:           SqliteInMemoryPath,
				ExtensionsPath: []string{tests.GetSqliteExtensionsPath()},
			}, l)
			grm, err := NewGormSqliteFromSqlite(s)
			assert.Nil(t, err)

			for _, v := range values {
				totalStakerOperatorPayout := v[0]
				operatorTokens := v[1]
				expectedResult := v[2]

				query := `select subtract_big(@totalStakerOperatorPayout, @operatorTokens) as amt`
				var result string
				res := grm.Raw(query, sql.Named("totalStakerOperatorPayout", totalStakerOperatorPayout), sql.Named("operatorTokens", operatorTokens)).Scan(&result)
				assert.Nil(t, res.Error)

				assert.Equal(t, expectedResult, result, "totalStakerOperatorPayout: %s", totalStakerOperatorPayout)
			}
		})
		t.Run("Should call big_gt", func(t *testing.T) {
			query := `select big_gt('100', '1') as gt`

			s := NewSqlite(&SqliteConfig{
				Path:           SqliteInMemoryPath,
				ExtensionsPath: []string{tests.GetSqliteExtensionsPath()},
			}, l)
			grm, err := NewGormSqliteFromSqlite(s)
			assert.Nil(t, err)

			var result string
			res := grm.Raw(query).Scan(&result)
			assert.Nil(t, res.Error)

			assert.Equal(t, "1", result)
		})
		t.Run("Should call numeric_multiply_c", func(t *testing.T) {
			query := `select numeric_multiply_c('100', '.1')`

			s := NewSqlite(&SqliteConfig{
				Path:           SqliteInMemoryPath,
				ExtensionsPath: []string{tests.GetSqliteExtensionsPath()},
			}, l)
			grm, err := NewGormSqliteFromSqlite(s)
			assert.Nil(t, err)

			var result string
			res := grm.Raw(query).Scan(&result)
			assert.Nil(t, res.Error)

			assert.Equal(t, "10.0", result)
		})
		t.Run("Should call sum_big_c", func(t *testing.T) {
			t.Skip("This function is actually an aggregate function")
			query := `select sum_big_c('100', '1')`

			s := NewSqlite(&SqliteConfig{
				Path:           SqliteInMemoryPath,
				ExtensionsPath: []string{tests.GetSqliteExtensionsPath()},
			}, l)
			grm, err := NewGormSqliteFromSqlite(s)
			assert.Nil(t, err)

			var result string
			res := grm.Raw(query).Scan(&result)
			assert.Nil(t, res.Error)

			assert.Equal(t, "101", result)
		})
		t.Run("Should call sum_big_c", func(t *testing.T) {
			values := [][]string{
				[]string{"2586595906852124520000000000000000000", "78563914570073760561000000000000000000", "0.03292346010260200000"},
				[]string{"75370449903508156204000000000000000000", "78563914570073760561000000000000000000", "0.95935201696553300000"},
				[]string{"596939049887864861000000000000000000", "78563914570073760561000000000000000000", "0.00759813271976700000"},
				[]string{"9929709825614976000000000000000000", "78563914570073760561000000000000000000", "0.00012639021209600000"},
				[]string{"2586595906852124520000000000000000000", "78563914570073760561000000000000000000", "0.03292346010260200000"},
				[]string{"75370449903508156204000000000000000000", "78563914570073760561000000000000000000", "0.95935201696553300000"},
				[]string{"596939049887864861000000000000000000", "78563914570073760561000000000000000000", "0.00759813271976700000"},
				[]string{"9929709825614976000000000000000000", "78563914570073760561000000000000000000", "0.00012639021209600000"},
				[]string{"2000000000000000000000000000000000000000", "2000000000000000000000000000000000000000", "1.00000000000000000000"},
				[]string{"2000000000000000000000000000000000000000", "2000000000000000000000000000000000000000", "1.00000000000000000000"},
			}
			s := NewSqlite(&SqliteConfig{
				Path:           SqliteInMemoryPath,
				ExtensionsPath: []string{tests.GetSqliteExtensionsPath()},
			}, l)
			grm, err := NewGormSqliteFromSqlite(s)
			assert.Nil(t, err)

			for _, v := range values {
				stakerWeight := v[0]
				totalWeight := v[1]
				stakerProportion := v[2]

				query := `select calculate_staker_proportion(@stakerWeight, @totalWeight)`

				var result string
				res := grm.Raw(query, sql.Named("stakerWeight", stakerWeight), sql.Named("totalWeight", totalWeight)).Scan(&result)
				assert.Nil(t, res.Error)

				resultDecimal, _ := decimal.NewFromString(result)
				expectedDecimal, _ := decimal.NewFromString(stakerProportion)

				assert.Equal(t, resultDecimal.Equal(expectedDecimal), true)
			}
		})
	})
}
